#!/usr/bin/env ruby

ADDED_OR_MODIFIED = ["A ", "AM", "M ", "MM"] # do no include files that are not staged.
OTHER_RUBY_FILES  = %w(Rakefile Gemfile .pre-commit)

changed_files = `git status --porcelain`
                .split(/\n/)
                .select { |file_name_with_status| file_name_with_status.start_with?(*ADDED_OR_MODIFIED) }
                .map { |file_name_with_status| file_name_with_status.split(" ")[1] }
changed_ruby_files = changed_files
                     .select { |file_name| File.extname(file_name) == ".rb" or OTHER_RUBY_FILES.include?(file_name) }
                     .join(" ")
changed_typescript_files = changed_files
                           .select { |file_name| File.extname(file_name) == ".ts" }
                           .join(" ")

exit(0) if changed_files.empty?

unless changed_ruby_files.empty? or system("rubocop #{changed_ruby_files}")
  puts("\n\nðŸ’¥ Fix ruby linting errors and stage changed,"\
       " or bypass hook with `git commit --no-verify`")

  puts("\nautofix errors with:\nrubocop -a #{changed_ruby_files}")
  exit($?.exitstatus)
end

unless changed_typescript_files.empty? or system("npm run lint")
  puts("\n\nðŸ’¥ Fix js linting errors with `npm run lintfix` and stage changed,"\
       " or bypass hook with `git commit --no-verify`")
  exit($?.exitstatus)
end

exit(0)
